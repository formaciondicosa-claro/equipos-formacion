<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control de Equipos - Mini App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">

  <div class="max-w-4xl mx-auto px-4 py-6">
    <!-- HEADER -->
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-xl font-bold">üì¶ Control de Equipos</h1>
        <p class="text-xs text-slate-400">
          Mini app para solicitudes y control de pr√©stamos
        </p>
      </div>
      <div id="user-info" class="hidden text-right text-xs text-slate-400">
        <div id="user-email"></div>
        <button id="logout-btn" class="mt-1 text-amber-400 underline">
          Cerrar sesi√≥n
        </button>
      </div>
    </header>

    <!-- LOGIN -->
    <section id="login-view" class="mt-10">
      <div class="bg-slate-900 p-6 rounded-2xl shadow-xl border border-slate-700 text-center">
        <p class="text-sm mb-4 text-slate-300">
          Inicia sesi√≥n con tu cuenta de Google para usar el sistema.
        </p>
        <button id="login-btn"
          class="px-4 py-2 bg-sky-600 rounded-full hover:bg-sky-500 text-sm">
          Iniciar sesi√≥n con Google
        </button>
      </div>
    </section>

    <!-- FORMADOR -->
    <section id="formador-view" class="hidden space-y-6">

      <div class="bg-slate-900 border border-slate-700 rounded-xl p-4">
        <h2 class="text-sm font-semibold mb-2">Nueva solicitud</h2>

        <label class="block text-xs mb-1">Formador</label>
        <select id="formador-select"
                class="w-full bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs mb-2"></select>

        <label class="block text-xs mb-1">Tipo de equipo</label>
        <select id="tipo-equipo-form"
                class="w-full bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs"></select>

        <label class="block text-xs mb-1 mt-2">Equipo</label>
        <select id="equipo-form"
                class="w-full bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs"></select>

        <label class="block text-xs mb-1 mt-2">Fecha de uso</label>
        <input id="fecha-uso" type="date"
               class="w-full bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs">

        <label class="block text-xs mb-1 mt-2">Motivo</label>
        <input id="motivo" type="text"
               class="w-full bg-slate-950 border border-slate-700 rounded px-2 py-1 text-xs"
               placeholder="Ej: Pr√°ctica, prueba de campo, etc.">

        <button id="btn-enviar-solicitud"
          class="w-full mt-3 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-full text-xs">
          Enviar solicitud
        </button>

        <div id="formador-status" class="text-[11px] mt-2"></div>
      </div>

      <div class="bg-slate-900 border border-slate-700 rounded-xl p-4">
        <h2 class="text-sm font-semibold mb-2">Mis solicitudes</h2>
        <div id="mis-solicitudes" class="space-y-2 text-xs"></div>
      </div>

    </section>

    <!-- ADMIN -->
    <section id="admin-view" class="hidden space-y-5">

      <div class="bg-slate-900 border border-slate-700 rounded-xl p-4">
        <div class="flex justify-between items-center mb-2">
          <h2 class="text-sm font-semibold">Solicitudes pendientes</h2>
          <button id="btn-semilla"
            class="text-[11px] px-2 py-1 rounded-full border border-slate-500 hover:bg-slate-800">
            Forzar recarga de equipos
          </button>
        </div>
        <div id="lista-pendientes" class="space-y-2 text-xs"></div>
      </div>

      <div class="bg-slate-900 border border-slate-700 rounded-xl p-4">
        <h2 class="text-sm font-semibold mb-2">Equipos prestados</h2>
        <div id="lista-prestados" class="space-y-2 text-xs"></div>
      </div>

      <div class="bg-slate-900 border border-slate-700 rounded-xl p-4">
        <h2 class="text-sm font-semibold mb-2">Equipos registrados</h2>
        <div id="lista-equipos" class="space-y-1 text-xs"></div>
      </div>

    </section>
  </div>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // 1. CONFIGURACI√ìN FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyBCLna-fGM4c7cpUcHnZzUY01Jfkk22u3A",
      authDomain: "equipos-de-formacion.firebaseapp.com",
      projectId: "equipos-de-formacion",
      storageBucket: "equipos-de-formacion.firebasestorage.app",
      messagingSenderId: "249416438280",
      appId: "1:249416438280:web:be76d25b13c7763abcb7bd",
      measurementId: "G-TTJ1WJNZ2N"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 2. DATOS PRE-CARGADOS
    const FORMADORES = [
      { nombre: "Duber Herney Mu√±oz Ramos", email: "duber.munoz@dico.com.co" },
      { nombre: "Jose Daniel Rubiano Rodriguez", email: "jose.rubiano@dico.com.co" },
      { nombre: "Miguel Oswaldo Gonzalez Casta√±o", email: "miguel.gonzalez@dico.com.co" },
      { nombre: "Sebastian David Merch√°n Junca", email: "sebastian.merchan@dico.com.co" },
      { nombre: "Nestor Jair Basante Apraez", email: "jair.basante@dico.com.co" },
      { nombre: "Andres Felipe Tarazona", email: "andres.tarazon@dico.com.co" },
      { nombre: "Juan Felipe Villamil Torres", email: "juan.villamil@dico.com.co" }
    ];

    const EQUIPOS_PREDEFINIDOS = [
      { tipo: "Medidor de campo", nombre: "Trilithic 360 Dsp", serie: "360624417" },
      { tipo: "Decodificador digital", nombre: "Dongle", serie: "GZ25020561829822" },
      { tipo: "Decodificador digital", nombre: "Dongle", serie: "GZ25020561829624" },
      { tipo: "Decodificador digital", nombre: "Dongle", serie: "HP460924120145195" },
      { tipo: "Decodificador", nombre: "Smart speaker", serie: "1" },
      { tipo: "Decodificador", nombre: "Claro box", serie: "D4CFF998DF9" },
      { tipo: "Decodificador", nombre: "Digital set top box", serie: "603222002527775" },
      { tipo: "Mesh router", nombre: "Mesh newland", serie: "810325160052873" },
      { tipo: "Mesh router", nombre: "Mesh newland", serie: "810325160053523" },
      { tipo: "Mesh router", nombre: "Mesh newland", serie: "810325160052734" },
      { tipo: "Mesh router", nombre: "Mesh newland", serie: "810325160051703" },
      { tipo: "Mesh router", nombre: "Mesh newland", serie: "810325160052870" },
      { tipo: "Mesh router", nombre: "Mesh newland", serie: "810325160052868" },
      { tipo: "Mesh router", nombre: "Mesh newland", serie: "810325160045517" },
      { tipo: "Mesh router", nombre: "Mesh newland", serie: "810325160052859" }
    ];

    const ADMIN_EMAILS = [
      "formaciondicosa@gmail.com"
    ];

    // 3. REFERENCIAS UI
    const loginView = document.getElementById("login-view");
    const formadorView = document.getElementById("formador-view");
    const adminView = document.getElementById("admin-view");

    const loginBtn = document.getElementById("login-btn");
    const logoutBtn = document.getElementById("logout-btn");
    const userInfo = document.getElementById("user-info");
    const userEmailEl = document.getElementById("user-email");

    const formadorSelect = document.getElementById("formador-select");
    const tipoEquipoForm = document.getElementById("tipo-equipo-form");
    const equipoForm = document.getElementById("equipo-form");
    const fechaUsoInput = document.getElementById("fecha-uso");
    const motivoInput = document.getElementById("motivo");
    const btnEnviarSolicitud = document.getElementById("btn-enviar-solicitud");
    const misSolicitudesDiv = document.getElementById("mis-solicitudes");
    const formadorStatus = document.getElementById("formador-status");

    const listaPendientes = document.getElementById("lista-pendientes");
    const listaPrestados = document.getElementById("lista-prestados");
    const listaEquipos = document.getElementById("lista-equipos");
    const btnSemilla = document.getElementById("btn-semilla");

    let currentUser = null;
    let equiposCache = [];

    // 4. LOGIN / LOGOUT
    loginBtn.addEventListener("click", () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider).catch(err => alert(err.message));
    });

    logoutBtn.addEventListener("click", () => auth.signOut());

    // Asegura que la colecci√≥n 'equipos' tenga datos
    async function asegurarEquiposCargados() {
      const snap = await db.collection("equipos").get();
      if (snap.empty) {
        const batch = db.batch();
        EQUIPOS_PREDEFINIDOS.forEach(eq => {
          const ref = db.collection("equipos").doc();
          batch.set(ref, {
            ...eq,
            estado: "disponible",
            activo: true
          });
        });
        await batch.commit();
      }
    }

    auth.onAuthStateChanged(async user => {
      currentUser = user;

      if (!user) {
        loginView.classList.remove("hidden");
        formadorView.classList.add("hidden");
        adminView.classList.add("hidden");
        userInfo.classList.add("hidden");
        return;
      }

      loginView.classList.add("hidden");
      userInfo.classList.remove("hidden");
      userEmailEl.textContent = user.email;

      const esAdmin = ADMIN_EMAILS.includes(user.email);

      await asegurarEquiposCargados();

      if (esAdmin) {
        adminView.classList.remove("hidden");
        formadorView.classList.add("hidden");
        iniciarAdmin();
      } else {
        formadorView.classList.remove("hidden");
        adminView.classList.add("hidden");
        iniciarFormador();
      }
    });

    // 5. FORMADOR
    function iniciarFormador() {
      cargarFormadoresSelect();
      cargarEquiposParaFormador();
      escucharMisSolicitudes();
    }

    function cargarFormadoresSelect() {
      formadorSelect.innerHTML = "";
      FORMADORES.forEach(f => {
        const opt = document.createElement("option");
        opt.value = f.nombre;
        opt.textContent = f.nombre;
        formadorSelect.appendChild(opt);
      });
    }

    async function cargarEquiposParaFormador() {
      const snap = await db.collection("equipos").orderBy("tipo").get();
      equiposCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));

      if (equiposCache.length === 0) {
        tipoEquipoForm.innerHTML = "";
        equipoForm.innerHTML = "";
        const opt = document.createElement("option");
        opt.textContent = "Sin equipos registrados";
        tipoEquipoForm.appendChild(opt);
        return;
      }

      const tipos = [...new Set(equiposCache.map(e => e.tipo))];
      tipoEquipoForm.innerHTML = "";
      tipos.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        tipoEquipoForm.appendChild(opt);
      });

      tipoEquipoForm.addEventListener("change", llenarSelectEquipos);
      llenarSelectEquipos();
    }

    function llenarSelectEquipos() {
      const tipo = tipoEquipoForm.value;
      equipoForm.innerHTML = "";

      const disponibles = equiposCache.filter(
        e => e.tipo === tipo && e.estado !== "prestado"
      );

      if (disponibles.length === 0) {
        const opt = document.createElement("option");
        opt.textContent = "No hay equipos disponibles de este tipo";
        equipoForm.appendChild(opt);
        return;
      }

      disponibles.forEach(e => {
        const opt = document.createElement("option");
        opt.value = e.id;
        opt.textContent = `${e.nombre} (${e.serie || "sin serie"})`;
        equipoForm.appendChild(opt);
      });
    }

    btnEnviarSolicitud.addEventListener("click", async () => {
      if (!currentUser) return;

      const formadorNombre = formadorSelect.value;
      const equipoId = equipoForm.value;
      const tipo = tipoEquipoForm.value;
      const fechaUso = fechaUsoInput.value;
      const motivo = motivoInput.value.trim();

      if (!equipoId || !motivo || !fechaUso || !formadorNombre) {
        formadorStatus.textContent = "Completa todos los campos.";
        formadorStatus.className = "text-[11px] text-amber-400";
        return;
      }

      const equipo = equiposCache.find(e => e.id === equipoId);
      if (!equipo) return;

      await db.collection("solicitudes").add({
        equipoId,
        equipoNombre: equipo.nombre,
        equipoSerie: equipo.serie,
        tipoEquipo: tipo,
        motivo,
        fechaUso,
        fechaSolicitud: new Date(),
        estado: "pendiente",
        formadorNombre,
        formadorEmail: currentUser.email
      });

      formadorStatus.textContent = "Solicitud enviada.";
      formadorStatus.className = "text-[11px] text-emerald-400";
      motivoInput.value = "";
    });

    function escucharMisSolicitudes() {
      db.collection("solicitudes")
        .where("formadorEmail", "==", currentUser.email)
        .orderBy("fechaSolicitud", "desc")
        .onSnapshot(snap => {
          misSolicitudesDiv.innerHTML = "";
          snap.forEach(doc => {
            const s = doc.data();
            const div = document.createElement("div");
            div.className =
              "border border-slate-700 rounded px-3 py-2 flex justify-between items-center";
            div.innerHTML = `
              <div>
                <div class="font-medium">${s.equipoNombre}</div>
                <div class="text-[11px] text-slate-400">
                  Uso: ${s.fechaUso} ‚Ä¢ Estado: ${s.estado}
                </div>
                <div class="text-[11px] text-slate-400">${s.motivo}</div>
              </div>
            `;
            misSolicitudesDiv.appendChild(div);
          });
        });
    }

    // 6. ADMIN
    function iniciarAdmin() {
      escucharSolicitudesAdmin();
      escucharEquiposAdmin();
    }

    function escucharSolicitudesAdmin() {
      db.collection("solicitudes")
        .orderBy("fechaSolicitud", "desc")
        .onSnapshot(snap => {
          listaPendientes.innerHTML = "";
          listaPrestados.innerHTML = "";

          snap.forEach(doc => {
            const id = doc.id;
            const s = doc.data();

            if (s.estado === "pendiente") {
              const div = document.createElement("div");
              div.className = "border border-slate-700 rounded px-3 py-2";
              div.innerHTML = `
                <div class="font-medium">${s.equipoNombre}</div>
                <div class="text-[11px] text-slate-400">
                  ${s.formadorNombre} (${s.formadorEmail})
                </div>
                <div class="text-[11px] text-slate-400">Motivo: ${s.motivo}</div>
                <button class="w-full mt-2 py-1 bg-sky-600 rounded-full text-xs"
                  onclick="aprobarSolicitud('${id}','${s.equipoId}')">
                  Entregar
                </button>
                <button class="w-full mt-1 py-1 bg-red-600 rounded-full text-xs"
                  onclick="rechazarSolicitud('${id}')">
                  Rechazar
                </button>
              `;
              listaPendientes.appendChild(div);
            }

            if (s.estado === "entregado") {
              const div = document.createElement("div");
              div.className =
                "border border-slate-700 rounded px-3 py-2 flex justify-between items-center";
              div.innerHTML = `
                <div>
                  <div class="font-medium">${s.equipoNombre}</div>
                  <div class="text-[11px] text-slate-400">
                    ${s.formadorNombre} (${s.formadorEmail})
                  </div>
                </div>
                <button class="px-3 py-1 bg-emerald-600 rounded-full text-xs"
                  onclick="marcarDevuelto('${id}','${s.equipoId}')">
                  Devuelto
                </button>
              `;
              listaPrestados.appendChild(div);
            }
          });
        });
    }

    function escucharEquiposAdmin() {
      db.collection("equipos")
        .orderBy("tipo")
        .onSnapshot(snap => {
          listaEquipos.innerHTML = "";
          snap.forEach(doc => {
            const e = { id: doc.id, ...doc.data() };
            const div = document.createElement("div");
            div.className =
              "border border-slate-700 rounded px-3 py-1 flex justify-between";
            div.innerHTML = `
              <div>${e.tipo} ‚Äî ${e.nombre} (${e.serie || "sin serie"})</div>
              <span class="text-[10px] text-slate-400">
                ${e.estado || "disponible"}
              </span>
            `;
            listaEquipos.appendChild(div);
          });
        });
    }

    // 7. CARGAR SEMILLA MANUAL (bot√≥n admin)
    async function cargarEquiposDeSemilla() {
      const batch = db.batch();
      EQUIPOS_PREDEFINIDOS.forEach(eq => {
        const ref = db.collection("equipos").doc();
        batch.set(ref, {
          ...eq,
          estado: "disponible",
          activo: true
        });
      });
      await batch.commit();
    }

    btnSemilla.addEventListener("click", async () => {
      await cargarEquiposDeSemilla();
      alert("Equipos recargados en la base de datos.");
    });

    // 8. FUNCIONES GLOBALES ADMIN
    window.aprobarSolicitud = async (solId, equipoId) => {
      await db.collection("solicitudes").doc(solId).update({
        estado: "entregado",
        fechaEntrega: new Date()
      });
      await db.collection("equipos").doc(equipoId).update({
        estado: "prestado"
      });
    };

    window.rechazarSolicitud = async solId => {
      await db.collection("solicitudes").doc(solId).update({
        estado: "rechazado"
      });
    };

    window.marcarDevuelto = async (solId, equipoId) => {
      await db.collection("solicitudes").doc(solId).update({
        estado: "devuelto",
        fechaDevolucion: new Date()
      });
      await db.collection("equipos").doc(equipoId).update({
        estado: "disponible"
      });
    };
  </script>

</body>
</html>
